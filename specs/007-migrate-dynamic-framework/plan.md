# Implementation Plan: Migrate to Dynamic Framework (PWA-Compatible)

**Branch**: `007-migrate-dynamic-framework` | **Date**: 2026-02-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/007-migrate-dynamic-framework/spec.md`

## Summary

Replace Lume (static site generator) with SvelteKit (full application framework) as the build and UI framework for the Set Card Game. The migration starts from a `sv create` scaffold with all tooling pre-configured (Vitest, ESLint, Prettier, TailwindCSS, static adapter), then rewrites 6 DOM-constructing files (694 lines) into Svelte 5 components, converts 14+ Deno test files to Vitest, adopts SvelteKit's file-based routing, and preserves all game functionality, PWA offline support, and static deployment to GitHub Pages. Pure game logic (14+ files) remains unchanged. Node.js/npm is the sole runtime — replacing the current Deno-based toolchain entirely. SvelteKit adds ~7–10 KB gzipped runtime overhead — total payload stays under the 100 KB constitution limit.

## Scaffolding Foundation

The project starts from the Svelte CLI scaffold:

```bash
npx sv create \
  --template minimal \
  --types ts \
  --add prettier eslint vitest="usages:unit,component" tailwindcss="plugins:none" sveltekit-adapter="adapter:static" \
  --install npm \
  <target-directory>
```

This provides out of the box:

- SvelteKit with `@sveltejs/adapter-static`
- TypeScript (`tsconfig.json` extending `.svelte-kit/tsconfig.json`)
- Vite config (`vite.config.ts`) with TailwindCSS + Vitest (two-project: browser/node)
- ESLint flat config (`eslint.config.js`) with TypeScript + Svelte + Prettier integration
- Prettier (`.prettierrc`) with Svelte + TailwindCSS plugins
- `.npmrc` with `engine-strict=true`
- `.prettierignore`, `.gitignore`
- Boilerplate: `src/app.html`, `src/app.d.ts`, `src/routes/+layout.svelte`, `src/routes/+page.svelte`, `src/routes/layout.css`
- Demo tests: `src/demo.spec.ts`, `src/routes/page.svelte.spec.ts`

The migration then modifies this scaffold to add the game.

## Technical Context

**Language/Version**: TypeScript (ESNext target), Node.js 22 LTS (22.13.0+)
**Primary Dependencies** (from scaffold): `svelte@^5`, `@sveltejs/kit@^2`, `@sveltejs/adapter-static@^3`, `@tailwindcss/vite@^4`, `vite@^7`, `vitest@^4`, `@vitest/browser-playwright`, `vitest-browser-svelte`, `playwright`, `eslint@^9`, `typescript-eslint@^8`, `eslint-plugin-svelte@^3`, `eslint-config-prettier`, `@eslint/compat@^2`, `prettier@^3`, `prettier-plugin-svelte@^3`, `prettier-plugin-tailwindcss`, `svelte-check@^4`, `typescript@^5`
**Additional Dependencies** (to add): `@vite-pwa/sveltekit`
**Storage**: N/A (client-side only, no persistence beyond service worker cache)
**Testing**: Vitest — two projects: `client` (Playwright browser for `*.svelte.spec.ts`) + `server` (Node.js for `*.test.ts`)
**Target Platform**: Modern evergreen browsers (Chrome, Firefox, Safari, Edge)
**Project Type**: Single-page web application (client-side only)
**Performance Goals**: First Contentful Paint < 1s, initial payload < 100 KB compressed
**Constraints**: Offline-capable PWA, static file deployment (GitHub Pages), Svelte compile-time runtime only
**Scale/Scope**: ~30 source files, ~88 KB current → ~95–98 KB projected build output

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

### Pre-Design Check

| Constitution Principle                                         | Status       | Notes                                                                                                        |
| -------------------------------------------------------------- | ------------ | ------------------------------------------------------------------------------------------------------------ |
| **I. Lightweight & Fast** — payload < 100 KB                   | PASS (tight) | Current ~88 KB + ~10 KB Svelte runtime = ~98 KB. Within budget.                                              |
| **I. Lightweight & Fast** — zero external runtime dependencies | VIOLATION    | Svelte ships ~7–10 KB runtime to browser. Justified: compile-time approach is minimal; user chose SvelteKit. |
| **I. Lightweight & Fast** — FCP < 1s on 3G Fast                | PASS         | Svelte's compiled output is fast — no virtual DOM diffing overhead.                                          |
| **I. Lightweight & Fast** — "Lume is the SSG"                  | VIOLATION    | Replacing Lume IS the feature. See Complexity Tracking.                                                      |
| **II. Offline-First** — SW caches all assets                   | PASS         | `@vite-pwa/sveltekit` with `injectManifest` preserves behavior.                                              |
| **II. Offline-First** — valid PWA manifest                     | PASS         | Manifest generated by `@vite-pwa/sveltekit`.                                                                 |
| **III. Simplicity** — YAGNI                                    | PASS         | SvelteKit simplifies routing and component model vs. hand-written DOM. Single runtime simpler than dual.     |
| **Runtime** — Deno                                             | VIOLATION    | Replacing Deno with Node.js/npm. User explicitly requested npm everywhere.                                   |
| **Build** — "Lume handles templating, asset pipeline"          | VIOLATION    | Same as above — replacing Lume IS the feature.                                                               |
| **Local dev** — "deno task only"                               | VIOLATION    | Node.js replaces Deno entirely: `npm run dev/build/test/lint`.                                               |
| **Testing** — "deno test"                                      | VIOLATION    | Vitest replaces Deno test. Test logic preserved; harness migrated.                                           |
| **Styling** — TailwindCSS                                      | PASS         | `@tailwindcss/vite` native plugin (scaffold-provided).                                                       |
| **Hosting** — GitHub Pages                                     | PASS         | `@sveltejs/adapter-static` produces static files.                                                            |
| **CI/CD** — GitHub Actions                                     | PASS         | Single runtime: `setup-node` only. Simpler pipeline.                                                         |

### Post-Design Check

| Constitution Principle | Status       | Notes                                                                                      |
| ---------------------- | ------------ | ------------------------------------------------------------------------------------------ |
| All pre-design checks  | Same         | No design decisions introduced new violations.                                             |
| **Payload < 100 KB**   | PASS (tight) | Svelte runtime confirmed ~7–10 KB gzipped. Total ~95–98 KB. Monitor during implementation. |
| **Simplicity**         | PASS         | Single runtime (Node.js) + declarative Svelte components = simpler than dual Deno+Lume.    |

**Gate result**: PASS — 6 violations are inherent to the feature (replacing Lume+Deno with SvelteKit+Node.js) and justified in Complexity Tracking below. User explicitly chose SvelteKit and npm everywhere.

## Project Structure

### Documentation (this feature)

```text
specs/007-migrate-dynamic-framework/
├── plan.md              # This file
├── research.md          # Phase 0 output — framework evaluation
├── data-model.md        # Phase 1 output — configuration model
├── quickstart.md        # Phase 1 output — developer guide
├── contracts/           # Phase 1 output — build tool interfaces
│   └── README.md
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

Files marked **SCAFFOLD** are generated by `sv create` and need no or minimal modification.
Files marked **MODIFY** are scaffold files that need changes for the game.
Files marked **NEW** are created on top of the scaffold.
Files marked **MOVE** are existing game logic moved to `src/lib/`.

```text
./
├── svelte.config.js         # MODIFY — add paths.base, fallback
├── vite.config.ts           # MODIFY — add @vite-pwa/sveltekit plugin
├── package.json             # MODIFY — add @vite-pwa/sveltekit dep, update name
├── eslint.config.js         # SCAFFOLD (no changes needed)
├── .prettierrc              # SCAFFOLD (no changes needed)
├── .prettierignore          # SCAFFOLD (no changes needed)
├── .npmrc                   # SCAFFOLD (engine-strict=true)
├── .gitignore               # SCAFFOLD (may need minor additions)
├── tsconfig.json            # SCAFFOLD (extends .svelte-kit/tsconfig.json)
├── src/
│   ├── app.html             # MODIFY — add icon link, meta tags
│   ├── app.d.ts             # SCAFFOLD (SvelteKit type declarations)
│   ├── service-worker.ts    # NEW (replaces src/pwa/src/service_worker.js)
│   ├── routes/
│   │   ├── +layout.svelte   # MODIFY — import layout.css, set up global layout
│   │   ├── +page.svelte     # MODIFY — title screen (replaces screens/title/)
│   │   ├── layout.css       # MODIFY — add existing Tailwind utilities/custom styles
│   │   └── play/
│   │       └── +page.svelte # NEW — play screen (replaces screens/play/)
│   └── lib/
│       ├── index.ts         # SCAFFOLD (re-exports)
│       ├── assets/
│       │   └── favicon.svg  # SCAFFOLD
│       └── game/            # MOVE from src/game/ — all game logic
│           ├── attributes/  # MOVE (unchanged)
│           ├── board/
│           │   ├── Board.svelte  # NEW (replaces component.ts)
│           │   ├── model.ts      # MOVE (unchanged)
│           │   ├── replacer.ts   # MOVE (unchanged)
│           │   └── ...
│           ├── card/
│           │   ├── Card.svelte   # NEW (replaces renderer.ts)
│           │   ├── model.ts      # MOVE (unchanged)
│           │   ├── equality.ts   # MOVE (unchanged)
│           │   └── ...
│           ├── deck/        # MOVE (unchanged)
│           ├── difficulty/  # MOVE (unchanged)
│           ├── selection/   # MOVE (unchanged)
│           ├── set/         # MOVE (unchanged)
│           └── state/       # MOVE (unchanged)
├── static/
│   ├── robots.txt           # SCAFFOLD
│   └── icons/               # MOVE from src/pwa/src/icons/
├── tests/
│   └── build.test.ts        # MODIFY — updated for build/ output
└── .github/
    └── workflows/
        ├── ci.yml           # MODIFY — Node.js only, npm ci/test/lint/build
        └── cd.yml           # MODIFY — npm run build, artifact path build/
```

**Structure Decision**: Built on top of `sv create` scaffold. Game logic moves to `src/lib/game/` (accessible via `$lib/game/`). 6 files rewritten as Svelte 5 components using runes. 14+ game logic files unchanged. 14+ test files migrated from Deno.test to Vitest. Scaffold demo files (`src/demo.spec.ts`, `src/routes/page.svelte.spec.ts`) deleted after initial setup.

## Complexity Tracking

> Constitution violations justified below.

| Violation                                           | Why Needed                                                                                                     | Simpler Alternative Rejected Because                    |
| --------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- |
| "Lume is the static site generator"                 | Replacing Lume with SvelteKit IS the feature — the user explicitly requested migrating to a dynamic framework. | Keeping Lume would not fulfill the feature request.     |
| "Lume handles templating, asset pipeline"           | SvelteKit replaces Lume's entire role (templating, routing, bundling, asset pipeline).                         | See above.                                              |
| "Zero external runtime dependencies: no frameworks" | Svelte compiles to minimal runtime (~7–10 KB gzipped). User explicitly chose SvelteKit.                        | Vite-only was proposed and rejected by user.            |
| "Runtime: Deno"                                     | Node.js/npm replaces Deno entirely. SvelteKit requires Node.js, and a single runtime is simpler.               | Dual Deno+Node was proposed; user chose npm everywhere. |
| "Local dev: deno task only"                         | `npm run` scripts replace `deno task`. Single toolchain.                                                       | See above.                                              |
| "Testing: deno test"                                | Vitest replaces Deno test runner. Standard for Vite/SvelteKit projects.                                        | Keeping Deno tests would require dual runtime.          |

**Required Constitution Amendments** (to be proposed in a separate PR after migration):

1. Replace "Lume is the static site generator" → "SvelteKit with adapter-static is the application framework"
2. Replace "no frameworks" → "Svelte is the UI framework (compile-time, minimal runtime)"
3. Replace "Deno" runtime references → "Node.js 22 LTS / npm"
4. Replace "deno test" → "Vitest"
5. Replace "deno task for local dev" → "npm scripts for all local commands"
